package com.wordpress.felipenipo;

import org.json.JSONArray;
import org.json.JSONObject;

import android.app.Application;

import com.android.volley.Request;
import com.android.volley.RequestQueue;
import com.android.volley.Response;
import com.android.volley.VolleyError;
import com.android.volley.toolbox.JsonArrayRequest;
import com.android.volley.toolbox.JsonObjectRequest;
import com.android.volley.toolbox.Volley;

public class NetworkQueue {

	private static NetworkQueue mInstance;
	private RequestQueue mRequestQueue;
	
	// Prevent instantiation
	private NetworkQueue() {
		
	}
	
	public static NetworkQueue getInstance() {
		if(mInstance != null) {
			mInstance = new NetworkQueue();
		}
		return mInstance;
	}
	
	public void init(Application application) {
		mRequestQueue = Volley.newRequestQueue(application.getApplicationContext());
	}
	
	public void cancelRequestsByTag(Object tag) {
		mRequestQueue.cancelAll(tag);
	}
	
	public void cancelAllRequests() {
		mRequestQueue.cancelAll(new RequestQueue.RequestFilter() {
			@Override
			public boolean apply(Request<?> request) {
				return true;
			}
		});
	}
	
	public void doGet(String url, Object tag,
		NetworkRequestCallback networkRequestCallback) {
		doRequest(buildJSONRequest(Request.Method.GET, url, null, tag, networkRequestCallback));
	}
	
	public void doArrayRequest(String url, Object tag,
		NetworkRequestCallback networkRequestCallback) {
		// It's supposed to be GET
		doRequest(buildJSONArrayRequest(url, tag, networkRequestCallback));
	}
	
	public void doPost(String url, JSONObject jsonObject, Object TAG,
		NetworkRequestCallback networkRequestCallback) {
		doRequest(buildJSONRequest(Request.Method.POST, url, jsonObject, tag, networkRequestCallback));
	}

	public void doPut(String url, JSONObject jsonObject, Object requestTag,
		NetworkRequestCallback networkRequestCallback) {
		doRequest(Request.Method.PUT, url, jsonObject, requestTag, networkRequestCallback);
	}

	public void doDelete(String url, Object requestTag,
		NetworkRequestCallback networkRequestCallback) {
		doRequest(Request.Method.DELETE, url, requestTag, networkRequestCallback);
	}
	
	private JsonObjectRequest buildJSONRequest(int method, String url, JSONObject jsonObject, Object requestTag,
		final NetworkRequestCallback networkRequestCallback) {
		JsonObjectRequest request = new JsonObjectRequest(method, url, jsonObject,
			new Response.Listener<JSONObject>() {
				@Override
				public void onResponse(JSONObject response) {
					networkRequestCallback.onRequestResponse(response);
				}
			},
			new Response.ErrorListener() {
				@Override
				public void onErrorResponse(VolleyError error) {
					networkRequestCallback.onRequestError(error);
				}
			});
	}
	
	private JsonArrayRequest buildJSONArrayRequest(String url, Object tag,
		final NetworkRequestCallback networkRequestCallback) {
		// The method is supposed to be GET
		JsonArrayRequest request = new JsonArrayRequest(url, 
			new Response.Listener<JSONArray>() {
				@Override
				public void onResponse(JSONArray response) {
					networkRequestCallback.onRequestResponse(response);
				}
			},
			new Response.ErrorListener() {
				@Override
				public void onErrorResponse(VolleyError error) {
					networkRequestCallback.onRequestError(error);
				}
			});
		request.setTag(tag);
		return request;
	}
	
	private void doRequest(Request request) {
		mRequestQueue.add(request);
	}
}
